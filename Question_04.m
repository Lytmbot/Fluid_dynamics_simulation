%% QUESTION 04
clear all

BODY = [2.543506267119428,41.23036634519274,0;
3.505001330331024,40.96037259025406,0;
4.484769819333549,40.76033189406336,0;
5.467489102332629,40.57526979844943,0;
6.452046679913503,40.40020933155859,0;
7.435110884816472,40.21710416748068,0;
8.406099958422448,39.97957932844722,0;
9.327198107799587,39.59548930371594,0;
10.12059162226351,38.99140744979458,0;
10.78632087205836,38.24601743668851,0;
11.39801742125075,37.45499076140063,0;
11.99515907557513,36.65285592673028,0;
12.5977350324946,35.85481915535448,0;
13.2337287482448,35.0833603789668,0;
13.94263371980656,34.37918157946489,0;
14.75301772340637,33.79522278312976,0;
15.64068457624817,33.33609977376522,0;
16.56746788755174,32.96100005012137,0;
17.51244689854905,32.63405883513509,0;
18.46725111156536,32.33694586354024,0;
19.43267781368946,32.07664199900496,0;
20.37072923964879,31.74344247819864,0;
21.12551539912118,31.09028837252118,0;
21.88069095425595,30.43498074137882,0;
22.59184144258519,29.73258118185193,0;
23.26568686028661,28.99373956269921,0;
24.1365108504151,28.63229857702219,0;
25.03092668460098,29.0669737632969,0;
25.71768358751771,29.78556450955644,0;
26.25189928056743,30.63079296532071,0;
26.73084140283427,31.50493130658704,0;
27.46095553718361,31.557776219753,0;
28.28692820392864,30.99407766659587,0;
29.08152369269427,30.38771952739657,0;
29.78016134754844,29.67416397775677,0;
30.21502239433801,28.78680581037128,0;
29.84054891278451,27.89586492898793,0;
29.31869496646422,27.04347499632424,0;
28.87205290528066,26.14900035036731,0;
28.49834020288355,25.22184954427841,0;
28.23975224429301,24.25689352301292,0;
28.14199868124274,23.26266873980988,0;
28.15871488793965,22.26306388715687,0;
28.23881426080157,21.26641083235956,0;
28.3788792921064,20.27645697886094,0;
28.60085918922847,19.30187532529953,0;
28.94605492628783,18.36437210084348,0;
29.44986637539868,17.50249428956151,0;
30.12222514693685,16.76462137718999,0;
30.91620671448837,16.15839556030084,0;
31.7654961532622,15.63278255394953,0;
31.26339474123614,15.00379013714362,0;
30.29338423441973,14.76142854583452,0;
29.31495207239392,14.55500375410917,0;
28.3308818860521,14.37748569349346,0;
27.33982410231586,14.24526865496998,0;
26.34126677697724,14.21092976269303,0;
25.34269271521577,14.25249311226357,0;
24.38953310221145,13.96786593082012,0;
23.47486655600646,13.56367958706252,0;
22.56912429793628,13.13994459742305,0;
21.68126917859345,12.6800601393885,0;
20.828884594485,12.15782999509887,0;
20.03581423193486,11.54965199680359,0;
19.34212906871318,10.83153887465677,0;
18.91043207762415,9.941833311167466,0;
19.24899213500644,9.014003222016335,0;
19.91864636890173,8.29062466264738,0;
20.826143515125,7.879740627282268,0;
21.80921604948545,7.896597501707923,0;
22.68025342599792,8.384673845264954,0;
23.64941206285401,8.59270171712445,0;
24.60199175180253,8.873632540962715,0;
25.39987061535698,9.472814307988545,0;
26.11720695127852,10.16935755100843,0;
27.04213736737853,10.47890487172818,0;
28.0400283083539,10.54372180993199,0;
29.03781041324805,10.61025191424288,0;
30.03527867141725,10.68136610216165,0;
31.03238509931794,10.75737184786438,0;
32.02901721043683,10.83935381275158,0;
33.02479519911459,10.93108121430718,0;
34.01892239255656,11.03912628224862,0;
35.00945866062924,11.17590478664319,0;
35.99001206900322,11.37075269265746,0;
36.93969718582505,11.68013639934251,0;
37.76230556692762,12.23490132957773,0;
38.12655415145433,13.14769933021405,0;
38.03419248596964,14.13946225021723,0;
38.8375052218866,14.62442674964963,0;
39.79074907479704,14.92641651187394,0;
40.75733530105644,15.18210673812746,0;
41.74180112296363,15.35611563045337,0;
42.72798192473424,15.52110977354515,0;
43.70259366330539,15.74441998516818,0;
44.66728659778901,16.00766683145818,0;
45.62540104777136,16.29398950478881,0;
46.57710982380092,16.60091848263425,0;
47.51878897551089,16.9372046433748,0;
48.44525459731982,17.31350137857366,0;
49.38969927537831,17.64043160854279,0;
50.3620894196401,17.87301844281375,0;
51.34316874012095,18.06651391936117,0;
52.327357447662,18.24361298497285,0;
53.31279367635182,18.41365148287062,0;
54.2967980661113,18.59159427045961,0;
55.26042914992775,18.85442080465927,0;
56.1338322981707,19.33533417765096,0;
56.89795480321592,19.97920538790022,0;
57.58962363191226,20.70101240416076,0;
58.23746165757018,21.46274802818091,0;
59.04488047895187,21.98840945110273,0;
59.15126645638622,21.07283746219244,0;
59.05221094745441,20.077765340633,0;
58.92955727433168,19.08547355591098,0;
58.71038460251099,18.11023298374808,0;
58.53482295941371,17.12793710020313,0;
58.85524392823562,16.21113100785047,0;
59.66573847223754,15.63247479530026,0;
60.57703663637104,15.22256051377813,0;
61.53387268291608,14.93434458275021,0;
62.5147436111312,14.74059225549846,0;
63.50337387990176,14.59045359755714,0;
64.49465608207886,14.45873395251405,0;
65.48688743937146,14.3343306796132,0;
66.47939077263715,14.2120960138174,0;
67.47159240780407,14.0874768558989,0;
68.46232001104474,13.95173092054585,0;
69.44642145905969,13.77545209190416,0;
70.3644975862065,13.40035375417222,0;
71.02222975904259,12.65008172330863,0;
71.79747765735814,12.02217799369966,0;
72.69372090910714,11.58191944419164,0;
73.57301192117556,11.11174901576142,0;
74.3684821095862,10.50650382273963,0;
75.29786585028471,10.16147100669306,0;
76.28132787624988,10.28243921579941,0;
77.14520014357768,10.77448303832277,0;
77.70349832086785,11.59218339417445,0;
77.47394645332228,12.51342906706262,0;
76.81581146053094,13.26565632788102,0;
76.10436390295159,13.96814439457237,0;
75.34669413009966,14.62049211020447,0;
74.55811096337823,15.23535985947415,0;
73.75778413306156,15.83488334683309,0;
72.9054968987801,16.35550928465594,0;
71.97099383937459,16.70770680470157,0;
70.98920309038218,16.89055381041962,0;
69.99092733201495,16.94636076797168,0;
68.99406578056401,17.02076066789365,0;
68.01161441818923,17.20465862463607,0;
67.04741863320209,17.46926933998848,0;
66.09987204600603,17.78843020685009,0;
65.1815089014376,18.18275221428614,0;
64.37945904057969,18.77006287800245,0;
63.91132040407926,19.64592862059771,0;
63.66469183361376,20.61440124723984,0;
63.48584571529366,21.59818864932259,0;
63.42012933255726,22.59465437779527,0;
63.53674614297378,23.58684352858585,0;
63.74659250578074,24.56447572091351,0;
63.98024937938356,25.53679333783343,0;
64.20825456427289,26.51044139752958,0;
64.41267941237256,27.4892783200338,0;
64.57279638522594,28.47622797553593,0;
64.65385903722515,29.47253588548995,0;
64.63466628794198,30.4719357077156,0;
64.52450397963536,31.46559259087918,0;
64.33669938451716,32.44735807596071,0;
63.99455654190241,33.38463412298172,0;
63.42906970512401,34.20696828258125,0;
62.77053706206274,34.95947836843183,0;
62.09092192523506,35.69274776453973,0;
61.2810508110286,36.26785999694329,0;
60.29738715702494,36.35717876925585,0;
59.33337852747263,36.09538479522454,0;
58.38628257841467,35.77444145653314,0;
57.43211366186051,35.47538934264748,0;
56.46525090188329,35.22045135714443,0;
55.4886988791966,35.00542824852091,0;
54.50426230633246,34.83024483213783,0;
53.5090005471445,34.75827847314901,0;
52.73194355699898,35.31177083175925,0;
52.24618492515887,36.18573370475817,0;
51.77143738870196,37.06585530656144,0;
51.29790350579944,37.94663129434599,0;
50.82613684575809,38.82835690216653,0;
50.35718961554385,39.71158194848972,0;
49.89041969063648,40.59595930264757,0;
49.42293532593166,41.4799596272079,0;
48.94664652024766,42.35922444353545,0;
48.43831555875865,43.22026258371349,0;
47.87842857975738,44.04857816446143,0;
47.26285151807606,44.83646486872176,0;
46.60715527486004,45.59137317653792,0;
45.91660590681919,46.31449621928145,0;
45.21655876127984,47.0257293870356,0;
45.07020342566688,47.99290352865374,0;
44.87187974492432,48.97020117858755,0;
44.58345006319722,49.92669813822712,0;
44.12838857818289,50.81641478039212,0;
43.66654889498329,51.70319134093715,0;
43.13228806066311,52.5450854959721,0;
42.42283192984468,53.24905413293906,0;
41.74083494136197,53.97908033776245,0;
41.20437198286998,54.82160639973411,0;
40.76047027960998,55.71754795187634,0;
40.28538852628758,56.59622370655031,0;
39.53089608861174,57.23268483490299,0;
38.56303791841166,57.4651969604225,0;
37.56778046893343,57.43036750757696,0;
36.79540542927762,56.82075095575159,0;
36.34489883438097,55.93330162371539,0;
35.78293364170443,55.32093049127683,0;
34.87978061091007,55.74921103298601,0;
33.98131238692412,56.18819112873082,0;
33.06920462327385,56.59798969695603,0;
32.13844462001823,56.96320643370968,0;
31.18077714381345,57.2492701541225,0;
30.19436343430249,57.40831580307018,0;
29.19531048455093,57.4346645637603,0;
28.20059265050627,57.33932789441722,0;
27.23621434137215,57.08174860065122,0;
26.36783802791475,56.59286080042386,0;
25.64987763109496,55.89864110957992,0;
24.95966345889835,55.17561413934483,0;
24.13602114090729,54.61781222129211,0;
23.16394349311286,54.3913204639569,0;
22.19698756338138,54.13952244396702,0;
21.36887600360416,53.61429122850222,0;
20.6192100648797,52.99961928052301,0;
19.65520196571883,52.74004065507634,0;
18.66865364139102,52.84316510072851,0;
17.75597753906352,52.46885745671838,0;
16.95915531015216,51.86517233371063,0;
16.21316845515115,51.19958214332259,0;
15.51342547625701,50.48534346784128,0;
14.84150737158553,49.74476148306691,0;
14.18621247789324,48.98941139026429,0;
13.55885221944972,48.21083550818588,0;
13.00172963732733,47.38127001393529,0;
12.56487296749079,46.48238266254002,0;
12.07342035717988,45.61770491375928,0;
11.16942578558713,45.24585859908828,0;
10.18019148419818,45.35596328884627,0;
9.283694312580305,45.78641932284126,0;
8.343064278681952,46.04993003028108,0;
7.34322096779179,46.03311371297458,0;
6.343273387281662,46.02304209949481,0;
5.344113461747472,45.986169315162,0;
4.365551984051585,45.79698291077558,0;
3.483068340382939,45.33084678082609,0;
2.756666513282977,44.65254122670491,0;
2.316784800311874,43.75778000656963,0;
2.03461038905123,42.79894883137211,0;
1.951328752051867,41.81167629057799,0;
2.543506267119428,41.23036634519274,0];
BODY = (flip(BODY(:,1:2)))';

%% CONSTANTS
global q;       % source strengths indexed by plate clockwise
global pt;      % list of (x,y) cooreds for points that make up the body
global Uinf;    % horizontal component of ambient flow velocity
global Vinf;    % verticle component of ambient flow velocity
global Xmj;     % X coords for mid point of planels
global Ymj;     % Y coords for mid point of planels
global S;       % length of panels indexed by plate clockwise
global a;       % in {local} start of panel
global b;       % in {local} end of panel

%% Establish axis handles
figure('Name','Streamlines','NumberTitle','off');
stream_lines = axes;
hold(stream_lines,'on');
axis(stream_lines,'equal')

%% BUILD POINTS FOR PANELS
N = size(BODY,2)-1;  % number of point
pt = BODY((1:2),:);
plot(stream_lines, pt(1,:),pt(2,:),'k');

%% SET UP CONSTANTS
Uinf = 10;   % background flow velocity 
Vinf = 0;

for z = 1 : N
    Xmj(z) = (pt(1,z+1) - pt(1,z))/2 + pt(1,z); % centre points
    Ymj(z) = (pt(2,z+1) - pt(2,z))/2 + pt(2,z); % centre points
    S(z) = sqrt( (pt(1,z+1) - pt(1,z))^2 + (pt(2,z+1) - pt(2,z))^2 ); % length of each panel
end

a = -S./2;
b = S./2;

%% GET THE COEFICIENTS FOR NORMAL VELOCITY INDUCED BY PLATE
v = zeros(N,N);
u = zeros(N,N);
V = zeros(1,N);
U = zeros(1,N);

for i = 1 : N
    for j = 1 : N        
        % hard code trigger to catch plates self inducing velocity
        if i == j
            v(i,j) = 0.5;
        else
            Xi = [pt(1,i) pt(1,i+1)];
            Yi = [pt(2,i) pt(2,i+1)];
            Xj = [pt(1,j) pt(1,j+1)];
            Yj = [pt(2,j) pt(2,j+1)];
            [v(i,j),u(i,j), V(i), U(i)] = GET_induced_norm_coeff(Xi,Yi,Xj,Yj,Uinf);            
            % v(i,j) the normal velocity induced by plate j at plate i
            % u(i,j) the tangential velocity induced by plate j at plate i
            % V the normal velcoity from the background flow at plate i
            % U the tangential component of the background flow at plat i
        end       
    end
end

q = (v\(V)')'; % 1 by 8 vector of plate sources strengths to create solid boundary

%% BUILD STREAMLINES 
dt = .1;
t0 = 0;
tf = 25;
tick = 1;

end_y =  max(pt(2,:)) + 0.5*(max(pt(2,:))-min(pt(2,:)));
start_y = min(pt(2,:)) - 0.5*(max(pt(2,:))-min(pt(2,:)));
step_y = (end_y - start_y)/25; % keep odd to skip stagnation
xp = min(pt(1,:)) - 0.5*(max(pt(1,:))-min(pt(1,:)));

for yp = start_y : step_y : end_y 
    
    XY = RK_4_2vars(dt,t0,tf,xp,yp);
    x_pos(tick,:) = XY(1,:); % x_positions along stream lines
    y_pos(tick,:) = XY(2,:); % y positions along stream lines
    dx(tick,:) = XY(3,:);    % corresponding velocity in the dx/dt = u direction
    dy(tick,:) = XY(4,:);    % and dy/dt = v direction
    tick = tick + 1;
        
end


[hC hC] = contourf(stream_lines,x_pos,y_pos,sqrt(dx.^2+dy.^2),100); 
%** note velocity info is taken directly from streamlines **%
set(hC,'LineStyle','none');
shading(stream_lines,'flat')
colormap(stream_lines,'spring'); % make it different to the fig in the notes...

for line = 1 : size(x_pos,1)
    plot(stream_lines,x_pos(line,:),y_pos(line,:),'k')
end
fill(stream_lines, pt(1,:),pt(2,:),'c'); % really different...

xlabel(stream_lines,'x')
ylabel(stream_lines,'y')
x_min = min(pt(1,:)) - 0.4*(max(pt(1,:))-min(pt(1,:)));
x_max = max(pt(1,:)) + 0.4*(max(pt(1,:))-min(pt(1,:)));
y_min = min(pt(2,:)) - 0.4*(max(pt(2,:))-min(pt(2,:)));
y_max = max(pt(2,:)) + 0.4*(max(pt(2,:))-min(pt(2,:)));
axis(stream_lines,[x_min x_max y_min y_max])
daspect(stream_lines,[1 1 1])

